{% extends "base.html" %}

{% block content %}

<div class="admin-home">
  <h1>Welcome Admin Team</h1>
  <h2>Please review instructions below to view student scores.</h2>
</div>
<details class="instructions-container" open>
  <summary class="instructions-header"><h1>Instructions</h1></summary>
  <div class="instructions-content">
    <p>This page allows admin users to view student scores and provide feedback on their weekly tests.</p>

    <h3>Step One</h3>
    <p>Enter the student ID into the search bar.</p>
    <h3>Step Two</h3>
    <p>Select the test you would like to review.</p>
    <h3>Step Three</h3>
    <p>Review the student's scores and provide feedback in the text box below.</p>
    
  </div>
</details>



  <div class="content">
        <input type="text" id="search-bar" placeholder="Enter the Student ID">
        <button type="submit" id="search-button">Search</button>

      <!--Empty div used to dynamically hold the list of weeks-->
    <div class="dropdown">
        <button class="dropbtn" id="week">Week Recording</button>
     <div id = "WkRecording" class="dropdown-content">
     </div>
    </div>

    <div id = "res">
      
    </div>
    <br>
        <div id="feedback-box" style="display: none;"> <!--Display has to be none initially-->
            <textarea id="feedback-input" placeholder="Enter your feedback here"></textarea>
            <button id="submit-feedback">Submit</button>
        </div>
     </div>
     <div>
      <label for="selectOption">Select option:</label>
      Plot
      <select id="selectOption">
        <option value="all">All</option>
        <option value="student1">Easy</option>
        <option value="student2">Medium</option>
        <option value="student2">Hard</option>
        <!-- Add more student options as needed -->
      </select>
      questions for
      <select id="selectOption">
        <option value="all">All Students</option>
        <option value="student1">Student 123</option>
        <!-- Add more student options as needed -->
      </select>
    
      <button onclick="plotScores()">Plot</button>
    </div>
    <br>
     Graph average scores across weeks
     <button id="student-graph">Selected Student's</button>
     <button id="week-graph">Group Average</button>
     <!-- <button id=""></button> -->
     <!-- average score over time
     score per question
     single student's score over time
     download excel sheet. -->
     <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
      <br>
      <br>
      
  </div>
  
  <script
  src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
  </script>

  <script>
    // global variables
    const submitButton = document.getElementById("search-button");
    const student_graph = document.getElementById("student-graph");
    const week_graph = document.getElementById("week-graph");
    const WkRecording = document.getElementById("WkRecording");
    const feedback_box = document.getElementById("feedback-box");
    const textarea_box = document.getElementById("feedback-input");
    const submitFeedbackButton = document.getElementById("submit-feedback");
    const container = document.getElementById("res");

    let weekNumbers = []
    let sysAverageScores = []
    let userAverageScores = []

    let graph_values = [];
    let student_values = [];
    let week_values = [];


    function setGraph(data, title) {
      const xValues = ["1", "2", "3", "4", "5", "6", "7", "8", "10", "11", "12"];
      new Chart("myChart", {
        type: "line",
        data: data, 
        options: {
          scales: {
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Score (%)'
              },
              display: true,
              ticks: {
                  suggestedMin: 0, 
                  suggestedMax: 100,    // minimum will be 0, unless there is a lower value.
                  // OR //
                  beginAtZero: true   // minimum value will be 0.
              },
            }],
            xAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Week'
              }
            }]
          },
          title: {
            display: true,
            text: title,
          },
        }
      });
    }
    
    setGraph(graph_values, "Click on button to graph")
    
    student_graph.onclick = () => {
      const data = {
        labels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"],
        datasets: [
          {
              label: 'System Average Scores',
              data: sysAverageScores.scores,
              backgroundColor: "rgba(210,50,210,0.3)",
          },
          {
              label: 'User Average Scores',
              data: userAverageScores.scores,
              backgroundColor: "rgba(210,0,0,0.3)"
          }
        ]
      };
      setGraph(data, "Student " + sysAverageScores.student_id + "'s Scores")
    }
    GettingTestMarks();
    week_graph.onclick = async () => {
      await GettingTestMarks(); 
      const data = {
        labels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"],
        datasets: [
          {
              label: 'System Average Scores',
              data: sysAverageScores,
              backgroundColor: "rgba(210,50,210,0.3)",
          },
          {
              label: 'User Average Scores',
              data: userAverageScores,
              backgroundColor: "rgba(210,0,0,0.3)"
          }
        ]
      };
      setGraph(data, "Average Scores by Week")
    }

    // on click, search for user
    submitButton.onclick = () => {
      let textvalue = document.getElementById("search-bar").value;
      if (textvalue != ""){
        GettingUser(textvalue);
        GettingUserMarks(textvalue);
        document.getElementById("search-bar").value = "";
      }
    }

    // searching for user, dynamically creates list if user exists
    function GettingUser(userID){
      const xml = new XMLHttpRequest();
      WkRecording.innerHTML = "";
      xml.open('POST',"/get-user",true);
      xml.setRequestHeader("Content-Type", "application/json");
      xml.onreadystatechange = function(){
        if(xml.readyState == 4){
          if(xml.status==200){
            let weeks = JSON.parse(xml.responseText).weeks;
            for (let value of weeks){
              let new_element = document.createElement('a');
              new_element.innerHTML = value;
              new_element.onclick =  function () {
              gettingAudioClips(userID, value); 
          };
              WkRecording.appendChild(new_element);
            }
          }
          else{
            alert("User does not exist or has not taken any tests");
            container.innerHTML = "";
            feedback_box.style.display="none";
          }
        }
      }
      console.log(userID)
      xml.send(JSON.stringify({ "userID": userID }));
    }

    function GettingUserMarks(userID){
      const xml = new XMLHttpRequest();
      WkRecording.innerHTML = "";
      xml.open('POST',"/get-user-marks",true);
      xml.setRequestHeader("Content-Type", "application/json");
      xml.onreadystatechange = function(){
        if(xml.readyState == 4){
          if(xml.status==200){
            let values = JSON.parse(xml.responseText);
            graph_values = values
            console.log(graph_values)
            extractChartData(values, userID);
          }
          else{
            alert("User does not exist or has not taken any tests");
            container.innerHTML = "";
            feedback_box.style.display="none";
          }
        }
      }
      xml.send(JSON.stringify({ "userID": userID }));
    }

    function GettingTestMarks(){
      const xml = new XMLHttpRequest();
      WkRecording.innerHTML = "";
      xml.open('POST',"/get-test-marks",true);
      xml.setRequestHeader("Content-Type", "application/json");
      xml.onreadystatechange = function(){
        if(xml.readyState == 4){
          if(xml.status==200){
            let values = JSON.parse(xml.responseText);
            graph_values = values
            console.log(graph_values)
            extractTestData(values);
          }
          else{
            alert("User does not exist or has not taken any tests");
            container.innerHTML = "";
            feedback_box.style.display="none";
          }
        }
      }
      xml.send();
    }

    // Gets audio clips after admin clicks a specific week
    function gettingAudioClips(userID,week){
      const xml = new XMLHttpRequest();
      xml.open('POST',"/get-audio",true);
      xml.setRequestHeader("Content-Type", "application/json");
      xml.onreadystatechange = function(){
        if(xml.readyState === 4){
          if(xml.status === 200){
            // get json data from request
            let json_data = JSON.parse(xml.responseText);
            let clips = json_data.clips;
            let user_scores = json_data.user_scores;
            let sys_scores = json_data.sys_scores;

            let arr_length = clips.length;
            container.innerHTML = "";

            let audio_path = `/static/audio/users/${userID}/${week}`;
            let image_path = `/static/images/users/${userID}/${week}`;
            for (let idx = 0; idx < arr_length; idx++){
              let small_container = document.createElement("div");

              // create audio element
              let aud_clip = document.createElement("audio");
              aud_clip.controls = true;
              aud_clip.type = "audio/wav";
              aud_clip.src = `${audio_path}/${clips[idx]}`;

              // create image element
              let img = document.createElement("img");
              let image_name = clips[idx].replace(".wav",".png");
              img.src = `${image_path}/${image_name}`;
              img.width = "400";
              img.height = "160";

              // create p element to hold scores and name
              let user_sc = document.createElement("p");
              user_sc.textContent = user_scores[idx];
              let sys_sc = document.createElement("p");
              sys_sc.textContent = sys_scores[idx];
              let name = document.createElement("p");
              name.textContent = clips[idx];

              // adds all the element to the container
              small_container.appendChild(name);
              small_container.appendChild(aud_clip);
              small_container.appendChild(img);
              small_container.appendChild(user_sc);
              small_container.appendChild(sys_sc);

              small_container.style.border = "1px solid black";
              container.appendChild(small_container);
            }

            feedback_box.style.display= "block";
            textarea_box.dataset.week = week;
            textarea_box.dataset.user = userID;
            gettingFeedback(userID,week,function(response){
              textarea_box.value = response;
            });

          }
          else{
            console.log("error");
          }
        }
      }
      xml.send(JSON.stringify({ "userID": userID, "week":week}));
    }

    // sending feedback to get saved
    function sendingFeedback(){
      let feedback = textarea_box.value;
      textarea_box.value = "";

      const xml = new XMLHttpRequest();
      xml.open('POST',"/save-feedback",true);
      xml.setRequestHeader("Content-Type", "application/json");
      xml.onreadystatechange = function(){
        if(xml.readyState == 4){
          if(xml.status==200){
            alert(`Feedback for user:${textarea_box.dataset.user} was saved!`);
          }else{
            alert("Feedback was not saved");
          }
        }
      }
      xml.send(JSON.stringify({"txt":feedback,"week":textarea_box.dataset.week,"user":textarea_box.dataset.user}))
      
    }

    submitFeedbackButton.onclick = function(){
      sendingFeedback();
    }
    // getting feedback from the DB
    function gettingFeedback(user,week,callback){
      const xml = new XMLHttpRequest();
      const url = `/get-feedback?user=${user}&week=${week}`;
      xml.open('GET', url, true);
      xml.setRequestHeader("Content-Type", "application/json");
      xml.onreadystatechange = function(){
        if(xml.readyState == 4){
          if(xml.status==200){
            callback(xml.responseText);
          }else{
            console.log('err');
            callback("");
          }
        }
      }
      xml.send();
    }
 
    function extractChartData(data, userID) {
      sysAverageScores = {student_id: userID, scores: []};
      userAverageScores = {student_id: userID, scores: []};

      for (const weekNumber in data) {
        if (data.hasOwnProperty(weekNumber)) {
          const weekData = data[weekNumber];
          sysAverageScores.scores.push(weekData.sys_average_score);
          userAverageScores.scores.push(weekData.user_average_score);
        }
      }
    }

    function extractTestData(data) {
      sysAverageScores = [];
      userAverageScores = [];

      for (const weekNumber in data) {
        if (data.hasOwnProperty(weekNumber)) {
          const weekData = data[weekNumber];
          sysAverageScores.push(weekData.sys_average_score);
          userAverageScores.push(weekData.user_average_score);
        }
      }
      console.log(sysAverageScores)
      console.log(userAverageScores)
    }

  </script>
{% endblock %}