{% extends "base.html" %}
{% block content %}
  <div class="content">
    <h1>New Audio</h1>
    <button class="save-button">Save</button>
  </div>
  <div class="content">
    <h1>Hello {{user}}</h1>
  </div>
  {% for clip in audio_clips%}
  <div class="segment"style="border: 2px solid black"> <!--this is where you can put the css file, so each "question is its own div"-->
    <audio class = "supplied_clip" id="{{clip}}" controls=true src="{{ url_for('static', filename='audio/' + week + '/' + clip + '.wav') }}"></audio>
    <img src="{{ url_for('static', filename='images/' + week + '/' + clip + '.png') }}" width="500" height="200"> <!--right now the img is way too big, will need to discuss appropriate sizing when generating img, also off centred-->
    <button class="record">Start Recording</button> <!-- perhaps add a microphone img-->
    <button class="submit">Submit</button> <!-- perhaps add a img-->
    <p class = "count">3</p>
  </div>
  {% endfor %}
  
  <script>
    // const saveButton = document.querySelector('.save-button');

    // saveButton.addEventListener('click', function() {
    //   const pageTitle = document.title;
    //   const pageContent = document.querySelector('.content').innerHTML;
      
    //   // Store data in local storage
    //   localStorage.setItem('pageTitle', pageTitle);
    //   localStorage.setItem('pageContent', pageContent);

    //   alert('Page information saved.');
    // });

    const recordButtons = document.querySelectorAll('button.record');
    const listOfDivs = document.querySelectorAll('div.segment');
    const submitButtons = document.querySelectorAll('button.submit');
    const submissionAttempts = document.querySelectorAll('p.count');
    const timeoutseconds = 3000; //adding a timeout as previously discussed (5000 = 5 seconds)

    let blobList = [];
    let mediaRecorders = [];
    let recordedChunksList = [];


    recordButtons.forEach((recordButton,index) => {
      recordButton.onclick = () => {
        listOfDivs[index].style.background = "red";
        navigator.mediaDevices.getUserMedia({audio:true}).then((stream) => {

          mediaRecorders[index] = new MediaRecorder(stream);
          recordedChunksList[index] = [];

          mediaRecorders[index].start();

          mediaRecorders[index].ondataavailable = (e) => {
            recordedChunksList[index].push(e.data);
          }
          
          mediaRecorders[index].onstop = () => {
            console.log("creating audioplayer");
            const blob = new Blob(recordedChunksList[index], {type: "audio/wav"});
            blobList[index] = blob;
            recordedChunksList[index] = [];
            
            const audioURL = URL.createObjectURL(blob);
            console.log(audioURL);

            const existingAudioPlayer = document.getElementById("audioplayer" + index);

            if (existingAudioPlayer){
              existingAudioPlayer.src = audioURL;

            }else{
              var audioPlayer = document.createElement("audio");
              audioPlayer.controls = true;
              audioPlayer.id = "audioplayer" + index;
              audioPlayer.src = audioURL;
              listOfDivs[index].appendChild(audioPlayer);
            }

          }

        }).catch((err)=>{
          console.log(err);
          alert("problem");
        });

        setTimeout(() => {
          listOfDivs[index].style.background="none";
          mediaRecorders[index].stop();
          // console.log(recordedChunksList[index], index);
        },timeoutseconds);

      }
    })

    submitButtons.forEach((submitButton,index) => {
      submitButton.onclick = () =>{
        var blob = blobList[index];
        // var xmlhttp = new XMLHttpRequest();
        var count = submissionAttempts[index];
        // console.log(count);
        if (blob && count.innerHTML != 0){
          console.log(blob);
          count.innerHTML--;
          const audioplayer = listOfDivs[index].querySelector('.supplied_clip');
          // console.log(audioplayer.id);
          let name_of_clip = audioplayer.id;
          let data_to_send = {
            "name": name_of_clip,
            "blob": blob,
            "attempt": count.innerHTML
          };
          let json_data = JSON.stringify(data_to_send);
          var xmlhttp = new XMLHttpRequest();
          xmlhttp.open("POST", "save-audio",true);
          xmlhttp.setRequestHeader("Content-Type", "application/json");
          xmlhttp.send(json_data);

        }

      }

    })
  </script>
{% endblock %}