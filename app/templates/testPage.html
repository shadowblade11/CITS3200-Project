{% extends "base.html" %}
{% block content %}
  <!-- <div class="content">
    <h1>New Audio</h1>
    <button class="save-button">Save</button>
  </div> -->
  <div class="test-content">
    <h1 class="flex">Welcome Student,&nbsp;<span id="user">{{user}}</span>!</h1>
    <h1 class="flex">This Is Test:&nbsp;<span id="week">{{week}}</span></h1>
  </div>
  {% for clip in audio_clips%}
  <div class="task-container"> <!--this is where you can put the css file, so each "question is its own div"-->
    <h1 class="task-header">Task: {{loop.index}}</h1>
    <div class="task">
      <div class="question-container">
        <img src="{{ url_for('static', filename='images/' + week + '/' + clip + '.png') }}" width="400" height="160"> <!--right now the img is way too big, will need to discuss appropriate sizing when generating img, also off centred-->
        <audio class = "supplied_clip" id="{{clip}}" controls controlslist="nofullscreen nodownload noremoteplayback noplaybackrate foobar" src="{{ url_for('static', filename='audio/' + week + '/' + clip + '.wav') }}"></audio>
      </div>
      <div class="response-container">
        <div class="button-container">
          <button class="record">Start Recording</button> <!-- perhaps add a microphone img-->
          <button class="submit">Submit</button> <!-- perhaps add a img-->
        </div>
        <div class="count-container">
          <p class = "count-text">Submissions:&nbsp;</p>
          <p class = "count">3</p>
        </div>
        <div class="self-assessment">
          <label for="score-{{loop.index}}">Similarity Score:</label>
          <input type="range" min="0" max="10" value="5" class="slider" id="simRange">
          <p>Value: <span id="startingscore"></span></p>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <script>
    /*
    const saveButton = document.querySelector('.save-button');

    saveButton.addEventListener('click', function() {
      const pageTitle = document.title;
      const pageContent = document.querySelector('.content').innerHTML;
      
      // Store data in local storage
      localStorage.setItem('pageTitle', pageTitle);
      localStorage.setItem('pageContent', pageContent);

    //   alert('Page information saved.');
    });
    */

    const recordButtons = document.querySelectorAll('button.record');
    const listOfDivs = document.querySelectorAll('div.task-container');
    const submitButtons = document.querySelectorAll('button.submit');
    const submissionAttempts = document.querySelectorAll('p.count');
    const timeoutseconds = 3000; //adding a timeout as previously discussed (5000 = 5 seconds)
    const userID = document.getElementById("user").innerHTML;
    const weekID = document.getElementById("week").innerHTML;

    let blobList = [];
    let mediaRecorders = [];
    let recordedChunksList = [];
    let newRecording = [];
    let RECORDING = 0;


    recordButtons.forEach((recordButton,index) => {
      recordButton.onclick = () => {
        // change div to red to indicate recording REMOVE LATER AS SHE DOES NOT WANT ANY RED ////////////////////////////////////////////////////////////////
        if (RECORDING == 0) {
          RECORDING = 1;
          listOfDivs[index].style.background = "yellow";
        
          navigator.mediaDevices.getUserMedia({audio:true}).then((stream) => {
            
            //initalise the recordedChunk to contain an empty list
            recordedChunksList[index] = [];
            
            // make new media recorder and push data to recordedchunk
            mediaRecorders[index] = new MediaRecorder(stream);
            mediaRecorders[index].ondataavailable = (e) => {
              recordedChunksList[index].push(e.data);
            }

            mediaRecorders[index].start();

            mediaRecorders[index].onstop = () => {
              // make a blob and add to list
              const blob = new Blob(recordedChunksList[index], {type: "audio/wav"});
              blobList[index] = blob;
              // clear the recordedchunk
              recordedChunksList[index] = [];
            
              
              //indicate that new audio clip has been made
              newRecording[index] = 1;

              // check if audioplayer exist and change src to audioclip
              const existingAudioPlayer = document.getElementById("audioplayer" + index);
              if (existingAudioPlayer){
                existingAudioPlayer.src = URL.createObjectURL(blob);

              }else{ //create new audioplayer if it doesn't exist
                var audioPlayer = document.createElement("audio");
                audioPlayer.controls = true;
                audioPlayer.id = "audioplayer" + index;
                audioPlayer.src = URL.createObjectURL(blob);
                listOfDivs[index].querySelector(".response-container").insertBefore(audioPlayer, listOfDivs[index].querySelector(".button-container"));
              }
              
            }
            
          }).catch((err)=>{
            console.log(err);
            alert("problem");
          });
        
          // add timeout to recording
          setTimeout(() => {
            listOfDivs[index].style.background="none";
            mediaRecorders[index].stop();
            RECORDING = 0;
          },timeoutseconds);
        }
      }
    });

    submitButtons.forEach((submitButton,index) => {
      submitButton.onclick = () =>{
        // make sure audioclip exists, submission is allowed, and its a new clip
        var blob = blobList[index];
        var count = submissionAttempts[index];
        var new_clip = newRecording[index];
        if (blob && count.innerHTML != 0 && new_clip == 1){
        // get needed information
          const audioplayer = listOfDivs[index].querySelector('.supplied_clip');
          let name_of_clip = audioplayer.id;

          //create form and json
          const formData = new FormData();
          formData.append('blob',blob);
          formData.append('user', userID);
          formData.append('week', weekID);
          formData.append('name', name_of_clip);
          formData.append('attempt', count.innerHTML);
          const json = JSON.stringify(
            {
              "user":userID,
              "name":name_of_clip,
              "week":weekID,
              "attempt":count.innerHTML
            }
          )

          //decrease count
          count.innerHTML = Number(count.innerHTML) - 1;

          // send audio to be saved
          var xmlhttp = new XMLHttpRequest();
          xmlhttp.open("POST", "/save-audio",true);
          xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == 4) {
                    if (xmlhttp.status == 200) {
                        // on success, request for image creation
                        xmlhttpImage = new XMLHttpRequest();
                        xmlhttpImage.open("POST","/send-image",true);
                        xmlhttpImage.setRequestHeader('Content-Type','application/json');
                        xmlhttpImage.send(json)

                        xmlhttpImage.onreadystatechange = function() {
                          if(xmlhttpImage.readyState==4){
                            if(xmlhttpImage.status==200){
                              name_of_clip = name_of_clip.replaceAll(' ','_');
                              
                              //path for image
                              let filename = '/static/images/users/' + userID + '/' + weekID + '/' + name_of_clip + '.png';

                              // check if img exist and update src
                              var img = document.getElementById("recorded_image" + index);
                              if(img){
                                img.src = filename + "?timestamp=" + new Date().getTime(); //workaround to updating images of same name
                              }else{ // create new img
                                var create_image = document.createElement("img");
                                create_image.src = filename;
                                create_image.width = "400";
                                create_image.height = "160";
                                create_image.id = "recorded_image" + index;
                                listOfDivs[index].querySelector(".response-container").insertBefore(create_image, document.getElementById("audioplayer" + index));
                              }
                            }
                            else{
                              console.log("error");
                            }
                          }
                        }

                    } else {
                        // Request failed
                        console.error("Request failed with status: " + xmlhttp.status);
                    }
                }
            };
          xmlhttp.send(formData);
          newRecording[index] = 0;
        }

      }

      // Slider Value
        var slider = document.getElementById("simRange");
        var output = document.getElementById("startingscore");
        output.innerHTML = slider.value;
        slider.oninput = function() {
          output.innerHTML = this.value;
        }

    })
  </script>
{% endblock %}