{% extends "base.html" %}
{% block content %}
  <div class="content">
    <h1>New Audio</h1>
    <button class="save-button">Save</button>
  </div>
  {% for clip in audio_clips%}
  <div class="segment"style="border: 2px solid black"> <!--this is where you can put the css file, so each "question is its own div"-->
    <audio controls=true src="{{ url_for('static', filename='audio/' + week + '/' + clip + '.wav') }}"></audio>
    <img src="{{ url_for('static', filename='images/' + week + '/' + clip + '.png') }}" width="500" height="200"> <!--right now the img is way too big, will need to discuss appropriate sizing when generating img, also off centred-->
    <button class="record">Start Recording</button> <!-- perhaps add a microphone img-->
  </div>
  {% endfor %}
  
  <script>
    // const saveButton = document.querySelector('.save-button');

    // saveButton.addEventListener('click', function() {
    //   const pageTitle = document.title;
    //   const pageContent = document.querySelector('.content').innerHTML;
      
    //   // Store data in local storage
    //   localStorage.setItem('pageTitle', pageTitle);
    //   localStorage.setItem('pageContent', pageContent);

    //   alert('Page information saved.');
    // });

    const recordButtons = document.querySelectorAll('button.record');
    const listOfDivs = document.querySelectorAll('div.segment');
    const timeoutseconds = 3000; //adding a timeout as previously discussed (5000 = 5 seconds)

    let audioStreams = [];
    let mediaRecorders = [];
    let recordedChunksList = [];

    recordButtons.forEach((recordButton,index) => {
      recordButton.onclick = () => {
        listOfDivs[index].style.background = "red";
        navigator.mediaDevices.getUserMedia({audio:true}).then((stream) => {


          mediaRecorders[index] = new MediaRecorder(stream);


          recordedChunksList[index] = [];
          mediaRecorders[index].start();


          console.log(mediaRecorders[index].state);


          mediaRecorders[index].ondataavailable = (e) => {
            recordedChunksList[index].push(e.data);
          }
          


          mediaRecorders[index].onstop = () => {
            console.log("creating audioplayer");
            const blob = new Blob(recordedChunksList[index], {type: "audio/wav"});
            recordedChunksList[index] = [];
            
            const audioURL = URL.createObjectURL(blob);
            console.log(audioURL);
            var audioPlayer = document.createElement("audio");
            document.body.append(audioPlayer);
            audioPlayer.controls = true;
            audioPlayer.src = audioURL //this line seems to be producing the error
          }



        }).catch((err)=>{
          console.log(err);
          alert("problem");
        });

        setTimeout(() => {
          listOfDivs[index].style.background="none";
          mediaRecorders[index].stop();
          // console.log(recordedChunksList[index], index);
        },timeoutseconds);

      }
    })
  </script>
{% endblock %}